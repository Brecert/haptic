var R=0,k=0,a,T,p=new Set,f=new WeakMap,l=[],E=[],d=[],y=[],b=[],A=e=>{let o=`rx#${k++}(${e.name})`,t={[o](){S(t)}}[o];return t.fn=e,t.runs=0,t.depth=a?a.depth+1:0,t.pause=()=>h(t),t.unsubscribe=()=>i(t),p.add(t),a&&a.inner.add(t),i(t),t},S=e=>{if(e.state===E)throw new Error(`Loop ${e.name}`);if(e.state===d)e.inner.forEach(S);else{i(e),e.state=E;let o=[];f.set(o,e),w(e,()=>e.fn(o)),e.runs++}e.state=e.sr.size?l:b},i=e=>{e.state=b,e.runs&&(e.inner.forEach(i),e.sr.forEach(o=>o.rx.delete(e))),e.sr=new Set,e.pr=new Set,e.inner=new Set},h=e=>{e.state=d,e.inner.forEach(h)},v=e=>(Object.keys(e).forEach(o=>{let t=e[o],s,r=`vocal#${R++}(${o})`,n={[r](...u){if(!u.length){if(a){if(a.sr.has(n))throw new Error(`Mixed sr/pr ${n.name}`);a.pr.add(n)}return t}if(s=f.get(u[0])){if(s.pr.has(n))throw new Error(`Mixed pr/sr ${n.name}`);return s.sr.add(n),n.rx.add(s),t}if(T){T.add(n),n.next=u[0];return}t=u[0],[...n.rx].sort((c,x)=>c.depth-x.depth).forEach(c=>{c.state===d?c.state=y:c.state===l&&S(c)})}}[r];n.rx=new Set,e[o]=n}),e),V=e=>{let o=T;T=new Set;let t,s;try{s=e()}catch(n){t=n}let r=T;if(T=o,t)throw t;return r.forEach(n=>{n(n.next),delete n.next}),s},w=(e,o)=>{let t=a;a=e;let s,r;try{r=o()}catch(n){s=n}if(a=t,s)throw s;return r};export{w as adopt,A as rx,p as rxKnown,V as transaction,v as vocals};
//# sourceMappingURL=index.js.map
